TITLE: Imker-Webapp v7 – MVP-first, QR-first, self-hosted, Notifs+i18n

GOAL
Phasenlieferung. QR→Stockkarte→Aktion ≤2 Klicks. Rechtssichere Daten. Robuste Sync. Benachrichtigungen. DE/EN.

AUDIENCE
Semi- bis Profi-Imker. Zeitersparnis, Compliance, Transparenz.

SCOPE & PRIORISIERUNG
Core MVP (Phase 1)
- Dashboard, Völker/Stockkarten, Durchsichten, TAMG, Sync, Auth (E-Mail+TOTP), Standorte, Dokumente (FileRef), Kalender/ICS.
Extended MVP (Phase 2)
- Backup & Restore, Bulk-Operationen, Reporting, Proben/Analytik, Ernte & Lose, Lager-Batches.
Polish (Phase 3)
- Kommentare, Gast read-only, Offline-Karten, Wetter-Prefetch, Sperrbezirk-Layer, Queen-Historie UI, Öffentliche Steckbriefe,
- Benachrichtigungen, i18n.

FEATURE-FLAGS (ENV)
- FEATURE_BACKUP, FEATURE_BULK, FEATURE_REPORTS, FEATURE_COMMENTS, FEATURE_GUEST
- FEATURE_OFFLINE_TILES, FEATURE_WEATHER_PREFETCH, FEATURE_NOTIFICATIONS, FEATURE_I18N
- FEATURE_MANUAL_TRACHT=true|false, FEATURE_WARTEZEIT_CASCADE=true|false

ARCHITEKTUR
Frontend
- Next.js App Router + TS + Tailwind + shadcn/ui. PWA (SW, Manifest). IndexedDB (Dexie).
- Route-Splitting. Heavy libs lazy (PDF, charts, map, audio).
- i18n: JSON Bundles pro Route, ICU, Locale-Provider, Persistenz; Fallback de.
Backend (self-hosted)
- Fastify + Postgres + MinIO + Keycloak/Ory.
- REST-ABI: `/sync/pull?cursor`, `/sync/push`, `/files/sign`, `/files/upload`, `/export/pdf`,
  `/ics/{workspace}/{token}`, `/public/*`, `/backup/export`, `/backup/import`,
  `/push/subscribe`, `/push/unsubscribe`, `/push/test`.

SCAN & FALLBACK
- Tabs: QR (Default), NFC (nur wenn `navigator.nfc`), Manuell. NFC-Fehler → Toast → QR.

ICS & SICHTBARKEIT
- Feeds: Workspace, Standort, Volk. Token revokebar.
- `ICS_PUBLIC_ENABLED=false` by default (read-only public off). Opt-in per Scope.

ÖFFENTLICHE STECKBRIEFE
- Opt-in pro Volk/Los → `publicId`. Backend-Route `/p/{publicId}`, noindex.
- Koordinaten: Default **ausgeblendet**. `PUBLIC_COORDS_MODE ∈ {hidden,rounded,full}`; `PUBLIC_COORD_PRECISION=2`.

AUDIO (Durchsicht Sprachmemo)
- Formate: m4a, mp3, ogg, wav. Prefer m4a/aac.
- Limits (ENV): `AUDIO_MAX_MINUTES=10`, `AUDIO_MAX_SIZE_MB=20`, `AUDIO_WORKSPACE_QUOTA_GB=2`.
- Speicherung: FileRef + Checksummen.
- Löschpolitik: `AUDIO_RETENTION_DAYS=30` nach erfolgreicher Transkription auto-Löschung der Rohdatei (optional). Quota-LRU mit Nutzerbestätigung.

WETTER & TRACHT
- WetterProvider: Open-Meteo (Default). Fallback: „Keine Prognose verfügbar“.
- Manuelle Trachtfenster (optional, Phase 3): `TrachtWindow { standortId, von, bis, intensität 0–3, quelle? }`.
- Planung nutzt Provider-Daten **oder** manuelle Fenster.

BACKUP & KEYS
- Export: `.tgz.age` (symmetrisch, Passphrase). Kein Server-Key.
- Passphrase-Wiederherstellung: **nicht** serverseitig möglich (Design).
- Empfohlenes Verfahren:
  - Recovery-Kit generieren: 3-von-5 Shamir-Shares der Passphrase (clientseitig), PDF/Print offline.
  - Optional Check-Fingerprint (KDF-Hash) lokal beim Admin, nicht auf Server.
  - Dokumentierte Wiederherstellungsprozedur im Admin-Manual.
- Cron & Retention wie v6.

ROLLEN & RECHTE
- Admin: alles.
- Editor: lesen/schreiben alle Module.
- Viewer: read-only.
- **Helfer**: read-write **nur** Durchsichten (+ Anhänge), lesen Völker/Standorte/TAMG, kein Export.
- Wiki-Reviewer: darf Wiki freigeben (Review/Publish).
- Phase 3: Gast-Token read-only.

VALIDIERUNG & PLAUSIBILITÄT
- Varroa-Schwellenwerte (Default, editierbar pro Saison/Region):
  - Alkohol-/Puderzucker-/CO₂-Waschung (300 Bienen): **Frühjahr ≥1 %**, **Sommer ≥2 %**, **Spätjahr ≥3 %** → Warn/Behandlungsempfehlung.
  - Natürlicher Milbenfall (Gemüll pro Tag): **Frühjahr ≥1**, **Sommer ≥10**, **Spätjahr ≥6**.
  - Werte als Profil: `VarroaThresholdProfile { region, saison, methode, schwellwert, einheit }`.
- HonigV-DE Etikett-Validierung:
  - Profil `EtikettProfil HonigV-DE v1` prüft Pflichtfelder: Verkehrsbezeichnung „Honig“, Füllmenge (g), Loskennzeichnung, MHD-Angabe („mindestens haltbar bis …“), Ursprungsland(e), Inverkehrbringer (Name+Anschrift).
  - Formatregeln (Regex/Masken) inkl. Datumsformat MHD. Keine Zusatztexte erzwungen.
- Wartezeit-Kaskaden (Option, ENV `FEATURE_WARTEZEIT_CASCADE`):
  - Wenn **≥1** Volk an Standort mit aktiver Wartezeit (`sperrBis > now`), dann **standortweite** Los-Sperre: Ernte/Lose des Standorts blockiert. UI-Hinweis + Quelle(n) anzeigen.
- Konsistenz:
  - `Σ HarvestLotAlloc.kg ≤ Ernte.kg`.
  - Ernte/Los blockiert bis `sperrBis`.
  - Etikettenexport nur bei vollständigem Profil.

SYNC & KONFLIKTE
- LWW pro Feld, Soft-deletes, cursorbasierter Pull, idempotenter Push.
- **Kritische Felder**: nie auto-überschreiben; erzwinge Merge-Dialog:
  - `Behandlung.sperrBis`, `Behandlung.wartezeitTage`
  - `Los.loscode`, `Los.etikettenfelder.*`, `Los.publicId`, `Los.oeffentlich`
  - `Ernte.kg` wenn bereits Allokationen existieren
  - `HarvestLotAlloc.kg`
  - `ICS.token`
  - `PublicToken.expiresAt/revokedAt`
  - `Rollen/Zugehörigkeiten`
- UI zeigt „Server vs. Lokal“ mit Feldwahl und Auditnote.

REPORTING
- Jahresübersicht, Standortvergleich. PDF serverseitig.

BULK-OPERATIONEN
- Wanderung Multi-Select; Fütterung per Standort/Filter; Behandlung Sammelbuchung. Vorschau+Zusammenfassung.

NOTIFICATIONS
- Web Push (VAPID), In-App Toast/Banner, Background Sync.
- Quellen: Kalender-Events, TAMG-Sperren, Zeugnis-Ablauf, TSK-Stichtag, Folgeaufgaben.
- Opt-in granular. Inhalte minimal. Deep-Links.

PERFORMANCE-BUDGETS
- Core Route JS ≤ 200 kB gz; /scan ≤ 160 kB; TTI ≤ 2 s; Interaktionen ≤ 100 ms.
- i18n-Bundles ≤ 20 kB gz pro Route; Notif-Code lazy bei Opt-in.

OBSERVABILITY & OPS
- `/healthz`, `/readyz`. Strukturierte Logs.
- SLOs: Sync-Push ≥ 99 %, Pull P95 < 1.5 s, Backup ≥ 99.5 %.
- Notif-KPIs: Opt-in, Deliveries/Clicks, Error < 1 %.
- RPO ≤ 24 h, RTO ≤ 2 h bei 10k Entities.

AKZEPTANZKRITERIEN (Zusatzziele)
- Varroa: Methode „Alkohol 300“ mit 3.2 % in Spätjahr → BLOCK/WARN laut Profil; Profiländerung pro Region greift sofort.
- Wartezeit-Kaskade: ein Volk am Standort mit `sperrBis` → Los-Erstellung/Export gesperrt, Hinweis nennt verursachende Behandlung.
- EtikettProfil HonigV-DE: fehlendes Ursprungsland → Export verweigert, Regelhinweis.
- ICS: default nicht öffentlich; Token erzeugt, aber Feed erst nutzbar nach Opt-in.
- Audio: Upload > `AUDIO_MAX_SIZE_MB` → abgewiesen; Auto-Löschung nach `AUDIO_RETENTION_DAYS`.
- Konflikt an `loscode`: Merge-Dialog zwingend, kein LWW.

ENTWICKLUNGSUMGEBUNG
- Zustand, RHF+Zod, Dexie. Vitest, Playwright. ESLint/Prettier.
- ENV: `BACKEND_PROVIDER`, `SIGNED_URL_TTL_MIN`, `PUBLIC_COORDS_MODE`, `PUBLIC_COORD_PRECISION`,
  `FEATURE_*`, `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`,
  `AUDIO_MAX_MINUTES`, `AUDIO_MAX_SIZE_MB`, `AUDIO_WORKSPACE_QUOTA_GB`, `AUDIO_RETENTION_DAYS`.
