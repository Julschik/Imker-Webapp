TITLE: Imker-Webapp v4 – Offline-first, QR-first, self-hosted Backend, Backup-ready

GOAL
Offline-first Webapp für Hobby- und Berufsimker. Kernfluss: QR→Stockkarte→Aktion ≤2 Klicks. Rechtssichere Daten. Saubere Exporte. Klare Sperr-/Warnlogik. Robuste Sync. Sichere Backups.

AUDIENCE
Semi- bis Profi-Imker. Fokus: Nutzen, Zeit, Compliance, Transparenz.

SCOPE v1.0 (MVP)
- Module: Dashboard, Standorte, Völker/Stockkarten, Durchsichten, Bestandsbuch (TAMG), Fütterung, Ernte & Lose, Wanderung, Proben/Analytik, Lager, Behörden/TSK, Dokumente, Kalender/Reminder, Wiki/Hilfe, Einstellungen/Rollen.
- Offline nutzbar. Delta-Sync online. Feldweises LWW; kritische Datensätze (Behandlung/Ernte/Los) mit einfachem Merge-Dialog.
- Rollen: Admin/Editor/Viewer (workspace-weit). 2FA (TOTP).
- **Backup & Restore**: Voll-Export verschlüsselt; Import/Migration zwischen Instanzen.
- **Bulk-Operationen**: Multi-Select für Wanderung, Fütterung, Behandlung.
- **Reporting**: vordefinierte Berichte „Jahresübersicht“ und „Standortvergleich“ (PDF).
- **Kommentare/Gast**: Kommentare an Durchsichten; read-only Gastlink pro Volk/Los.
- **Validierungen**: Plausibilitäts- und Konsistenzchecks.
- **Offline-Erweiterungen**: Tile-Caching für Karten; Wetter-Prefetch.

OUT OF SCOPE v1.0
- Objekt-ACL, E2E-Feldverschlüsselung, Gamification, vollumfängliches WMS, CRDT.

ARCHITEKTUR
Frontend
- Next.js App Router + TS + Tailwind + shadcn/ui. PWA (SW, Manifest). IndexedDB (Dexie).
- Routen je Modul. Code-Splitting. Virtuelle Tabellen.

Backend (Referenz, self-hosted, kein Lock-in)
- Fastify (Node) + Postgres + MinIO (S3) + Keycloak/Ory.
- REST-ABI: `/sync/pull?cursor`, `/sync/push`, `/files/sign`(PUT/GET), `/files/upload`, `/export/pdf`, `/ics/{workspace}/{token}`, `/public/*`, `/backup/export`, `/backup/import`.
- Supabase-Adapter mit identischer REST-ABI via Edge Functions (umschaltbar per `.env`).

UPLOAD/DOWNLOAD
- `FileRef { id, storageKey, mime, bytes, sha256, createdAt, signedUrl? }`.
- Direct-to-storage via pre-signed PUT; TTL `signedUrl` default 15 min (konfigurierbar). Fallback Multipart.
- Checksummenpflicht. Downloads nur signiert.

SYNC
- Soft-deletes, `updatedAt/updatedBy`. Push idempotent, Pull cursorbasiert. Kritische Konflikte mit Feldwahl.

SCAN & IDENTIFIKATION
- „Scannen“ Tabs:
  1) **QR** (Default) Kamera-Live.
  2) **NFC** nur sichtbar bei `navigator.nfc`; Fehler → Toast → Rückfall zu QR.
  3) **Manuell**: Suche nach Stock-Nr./QR-Key.
- Web Share für Deep-Links.

ÖFFENTLICHE STECKBRIEFE / GAST
- Opt-in pro Volk/Los → `publicId`.
- **Steckbrief**: `/p/{publicId}` vom Backend, read-only, noindex, Koordinaten gerundet/ausblendbar.
- **Gastzugang**: zeitlich begrenzter Token-Link read-only pro Entität oder Standort.

PROVIDER-INTERFACES
- WetterProvider: Open-Meteo (Default), austauschbar.
- TranskriptProvider: Whisper lokal oder OpenAI Whisper (über `FileRef`-Roundtrip).
- SperrbezirkProvider: GeoJSON-Upload via Admin-UI, Quelle pro Layer speicherbar.

BACKUP & RESTORE
- UI-Aktion „Verschlüsseltes Backup erstellen“ → Download Archiv (`.tgz.age`): `meta.json`, `entities/*.jsonl`, `files/` optional inkl. Manifest.
- Verschlüsselung symmetrisch per Passphrase (libsodium/age). Keine Passphrase im Server.
- Restore: Upload Archiv, Dry-Run-Report (Counts, Konflikte), dann Import mit Mapping-Optionen (Workspace neu/merge). Medien in Queue mit Retry.
- Automatische Zeitpläne optional serverseitig (Cron). Export auch ohne Medien (nur Referenzen).

BULK-OPERATIONEN
- **Wanderung**: Multi-Scan/Select → gemeinsamer Auftrag.
- **Fütterung**: Standort/Filter → Typ/Methode/Menge pro Volk oder verteilt.
- **Behandlung**: Sammelbuchung mit Dosis-Schema, Wartezeit-Sperre pro Ziel.

REPORTING
- **Jahresübersicht**: Völkerzahl, Erträge, Behandlungen, Verluste, Varroa-Übersicht, Export PDF (druckoptimiert).
- **Standortvergleich**: Ertrag/Volk, Wassergehalt, Behandlungsintensität, Export PDF.
- Serverseitige PDFs. Client-Fallback optional.

VALIDIERUNG & PLAUSIBILITÄT
- Eingabeguards: z. B. Honigertrag/Volk Warnung > 45 kg, Wassergehalt 14–23 % Info, Varroa-Dosis-Schranken je Präparat.
- Konsistenz: Summe `HarvestLotAlloc` ≤ Ernte; Ernte gesperrt bis `sperrBis`; Los nur mit vollständigen Etikettendaten exportierbar.
- Hard-Stop vs. Warnung konfigurierbar.

OFFLINE-ERWEITERUNGEN
- **Karten**: Tile-Caching (konfigurierbarer Provider). „Standbesuch vorbereiten“ speichert Tiles der Umgebung.
- **Wetter**: Letzte Prognose cached; Standbesuch triggert Prefetch 3–7 Tage je Standort.

DATENMODELL (fachlich, ergänzt)
Common
- Address, Geo wie V3.
- Comment { id, entity, entityId, authorId, text, createdAt }

User, Workspace, Membership wie V3.

Standort, Queen, QueenEvent, Volk, Durchsicht, Behandlung, Fütterung, Ernte, Los, HarvestLotAlloc, GlaeserMapping, Probe, Wanderung, Lager*, BehoerdenTSK*, Dokument, KalenderEvent, WikiArtikel – wie V3, plus:
- Comment-Bezüge auf Durchsicht/Volk/Standort/Los.
- Public/Gast Tokens: `{id, entity, entityId, scope, expiresAt, revokedAt?}`.

ÖFFENTLICHE STECKBRIEFE
- Minimalfelder definieren: Stocknr, Rähmchenmaß, Beute, Königin-Jahr, letzte Ernte (optional), keine exakten Koordinaten.

COMPLIANCE
- TAMG vollständig, Wartezeit-Sperre. TSK Stichtag/Frist. Zeugnisse Upload/Ablauf.
- Änderungslog für TAMG-Katalog-Versionen bleibt.

UX RULES
- Mobile first. Ampeln. Segment-Buttons. Kurze, handlungsleitende Fehlertexte.
- Bulk-Flows mit Vorschau und Zusammenfassung.

ANALYTIK
- Ertrag je Volk/Stand/Saison; Medikamenteneinsatz; Varroa-Kurven/Wirksamkeit; Jahresvergleich.
- Export PNG/PDF.

KALENDER & ICS
- In-App Kalender. ICS via `/ics/{workspaceId}/{token}`. Token widerrufbar.

EXPORTS
- CSV/JSON je Modul. PDFs: Bestandsbuch, TSK-Meldungen, Etikettendaten, vordefinierte Berichte.

SECURITY & PRIVACY
- EU-Hosting möglich. TLS. At-Rest-Verschlüsselung im Storage. 2FA.
- Rollen workspace-weit. Objekt-ACL Phase 2.
- Keine öffentlichen Buckets. Noindex Public.

AKZEPTANZ (Stichproben)
- Backup erzeugen, lokal speichern, auf zweiter Instanz Dry-Run, dann Import, Daten konsistent.
- Bulk-Fütterung eines Standorts: 20 Völker, Sammelbuchung erstellt, Summen korrekt.
- Bulk-Behandlung setzt `sperrBis` je Volk; Ernte blockiert bis Ablauf.
- QR→Durchsicht offline, später Whisper-Import, Folgeaufgaben erzeugt.
- Ernte↔Los Allokation konsistent; Etiketten-Export vollständig.
- Gastlink read-only zeigt Volk, keine sensiblen Daten, läuft ohne Login.
- Karten- und Wetterdaten im Standbesuch offline verfügbar.

ENTWICKLUNGSUMGEBUNG (Tooling)
- Zustand, RHF+Zod, Dexie. Tests: Vitest, Playwright. Lint/Format: ESLint/Prettier.
- PDF serverseitig (Fastify). ENV: `BACKEND_PROVIDER`, `SIGNED_URL_TTL_MIN`, `PUBLIC_COORD_PRECISION`, `BACKUP_CRON?`.
