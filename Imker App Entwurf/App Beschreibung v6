TITLE: Imker-Webapp v6 – MVP-first, QR-first, self-hosted, Notifs+i18n

GOAL
Lieferbar in Phasen. Kernfluss: QR→Stockkarte→Aktion ≤2 Klicks. Rechtssichere Daten. Robuste Sync. Benachrichtigungen für Fristen. DE/EN i18n.

AUDIENCE
Semi- bis Profi-Imker. Zeitersparnis, Compliance, Transparenz.

SCOPE & PRIORISIERUNG
Core MVP (Phase 1)
- Dashboard, Völker/Stockkarten, Durchsichten, TAMG, Sync, Auth (E-Mail+TOTP), Standorte, Dokumente (FileRef), Kalender/ICS.
Extended MVP (Phase 2)
- Backup & Restore, Bulk-Operationen, Reporting, Proben/Analytik, Ernte & Lose, Lager-Batches.
Polish (Phase 3)
- Kommentare, Gast read-only, Offline-Karten, Wetter-Prefetch, Sperrbezirk-Layer, Queen-Historie UI, Öffentliche Steckbriefe,
- **Benachrichtigungen/Erinnerungen**,
- **i18n DE/EN**.

FEATURE-FLAGS (ENV)
- FEATURE_BACKUP, FEATURE_BULK, FEATURE_REPORTS, FEATURE_COMMENTS, FEATURE_GUEST,
  FEATURE_OFFLINE_TILES, FEATURE_WEATHER_PREFETCH,
  **FEATURE_NOTIFICATIONS**, **FEATURE_I18N** = true|false

ARCHITEKTUR
Frontend
- Next.js App Router + TS + Tailwind + shadcn/ui. PWA (SW, Manifest). IndexedDB (Dexie).
- Route-Splitting. Heavy libs lazy (PDF, charts, map, audio).
- **i18n**: JSON Resource-Bundles pro Route, lazy geladen; ICU Messages; Locale-Provider; Persistenz via `localStorage`; Fallback `de`.
Backend (self-hosted)
- Fastify + Postgres + MinIO + Keycloak/Ory. REST-ABI: `/sync/pull?cursor`, `/sync/push`, `/files/sign`, `/files/upload`, `/export/pdf`, `/ics/{workspace}/{token}`, `/public/*`, `/backup/export`, `/backup/import`,
  **`/push/subscribe`, `/push/unsubscribe`, `/push/test`**.
- Supabase-Adapter optional, identische ABI.

BENACHRICHTIGUNGEN
- Service Worker: Push, notificationclick, background-sync.
- Web Push selbst gehostet (VAPID). Subscriptions pro User+Device gespeichert.
- Quellen: Kalender-Events, TAMG-Sperren, Ablauf Gesundheitszeugnisse, TSK-Stichtage, offene Folgeaufgaben.
- Typen: Push (server-getriggert), In-App Toast, Banner. **Offline-Reminder**: AlarmQueue im IndexedDB; Prüfung bei App-Fokus und Periodic Background Sync (falls verfügbar). Fallback über ICS.
- Opt-in Flow: Permission-Gating, granular pro Kanal. Stilles Abo nicht.
- Inhalte minimal, klick führt Deep-Link in App.

i18n
- Sprachen: `de` primär, `en` sekundär.
- Locale-Detection: Browser-Language (Whitelist) → gespeicherte User-Preference.
- Formatierung: `Intl` für Datum/Zahl/Einh.; Einheiten lokalisiert.
- Übersetzungen versioniert; fehlende Strings fallen auf `de`.

SYNC
- Unverändert v5: LWW pro Feld, kritische Merge-Dialoge, Soft-deletes, Push idempotent, Pull Cursor.

SCAN & FALLBACK
- Tabs: QR default, NFC bei `navigator.nfc`, Manuell. Fehler→Toast→Rückfall zu QR. Web Share aktiv.

BACKUP & RESTORE, BULK, REPORTING
- Wie v5. Unverändert. Cron und Retention per ENV.

VALIDIERUNG
- Plausibilitäten und Konsistenzregeln wie v5. Modus WARN|BLOCK per ENV.

ÖFFENTLICH/GAST, OFFLINE-ERWEITERUNGEN
- Wie v5. Steckbrief noindex; Tiles+Wetter via Standbesuch.

PERFORMANCE-BUDGETS
- Core Route JS ≤ 200 kB gz; /scan ≤ 160 kB; TTI ≤ 2 s; Interaktionen ≤ 100 ms.
- i18n Bundles per Route ≤ 20 kB gz; Notif-Code lazy nur bei Opt-in.

OBSERVABILITY & OPS
- Health `/healthz`,`/readyz`. Strukturierte Logs.
- SLOs: Sync-Push ≥ 99 %, Pull P95 < 1.5 s, Backups ≥ 99.5 %.
- **Notif-KPIs**: Opt-in-Rate, Deliveries/Clicks, Error-Rate < 1 %.
- RPO ≤ 24 h, RTO ≤ 2 h auf 10k Entities.

SECURITY & PRIVACY
- TLS, 2FA. Signierte URLs TTL 15 min. EU-Hosting möglich. Keine öffentlichen Buckets.
- Web Push: VAPID Keys serverseitig; Subscriptions mit Hash; Widerruf jederzeit.
- Notifs ohne sensible Inhalte. i18n Inhalte trusted-only.

UX RULES
- Mobile first. Ampeln. Segment-Buttons. Kurze, handlungsleitende Fehler.
- Scan→Stockkarte→Aktion ≤ 2 Klicks.
- Notif-Opt-in kontextbezogen (z. B. nach Erstellen einer Frist).

AKZEPTANZKRITERIEN
Phase 1
- QR-Scan → Durchsicht offline → Online sync → TAMG-Sperre wirkt auf Ernte/Los. ICS abonnierbar.
Phase 2
- Vollbackup erzeugen, Dry-Run, Import; Bulk-Fütterung Standort; Jahresbericht PDF.
Phase 3
- **Notifications**: User aktiviert Push; Termin in 24 h erzeugt; Push erscheint; Klick öffnet Deep-Link; Offline-Reminder zeigt Banner bei App-Fokus ohne Netz.
- **i18n**: Sprache auf EN umstellbar; Texte, Datums-/Zahlformat wechseln; Einstellung persistiert; Fallbacks korrekt.

ENTWICKLUNGSUMGEBUNG
- Zustand, RHF+Zod, Dexie. Vitest, Playwright. ESLint/Prettier.
- ENV: `BACKEND_PROVIDER`, `SIGNED_URL_TTL_MIN`, `PUBLIC_COORD_PRECISION`, `FEATURE_*`,
  `VAPID_PUBLIC_KEY`, `VAPID_PRIVATE_KEY`, `BACKUP_*`.
